# Vulnerability recurrence 

### The first loophole to reproduce is  CVE-2020-1021 

The code is based on an excellent vulnerability report  https://github.com/guhe120/Windows-EoP/blob/master/CVE-2020-1021/writeup.docx 

This code is only capable of triggering vulnerabilities wersvc!CWerService::SvcCollectMemoryInfo

My experimental environment is 1903 x64

I want to record something：

If the MaxMessageLength field in the fourth parameter ALPC_PORT_ATTRIBUTES of NtAlpcConnectPort is not set, then the length of the message sent by NtAlpcSendWaitReceivePort cannot exceed 0x200, and a 0xC000002F will be returned

If the sending length exceeds the maximum length specified by the server (NtAlpcSendWaitReceivePort is the third parameter from the bottom), you will get a 0xC0000707 

CreateFile will not be affected by disk storage space. WriteFile will 

### The second recurring vulnerability is CVE-2020-1515 

My experimental environment is 1903 x64

This is an integer overflow vulnerability in tapisrv.dll. From the perspective of the patch, the functions that have been patched include PInitialize, LInitialize, GetUIDllName and other functions, and the causes of the vulnerability are all integers, overflow，This vulnerability is an out-of-bounds heap write caused by an integer overflow. 

One big limitation is that in order to trigger an overflow, the server needs to have enough memory, otherwise it will return rpc error 14 

To call these functions, you need to connect to the tapisrv.dll server as an rpc client, and then you need to call ClientAttach to get a context_handle, and then call ClientAttach. ClientAttach will choose which function to call according to the value of parameter three

This code calls PInitialize, bypasses IsBadStringParam, but is only close to overflow 

1: kd>   
tapisrv!PInitialize+0xa3:  
0033:00007ffe 39672a63 4503c7 add r8d,r15d  
1: kd>   
tapisrv!PInitialize+0xa6:   
0033:00007ffe 39672a66 ff15dc980100 call qword ptr [tapisrv!_imp_HeapAlloc (00007ffe 3968c348)]   
1: kd> r r8   
r8=00000000ffffff6c    

I want to record something： 

By default, the rpc server will have the parameter to check [in], but not [out], because the server will not accept the value with the [out] parameter, but only accepts a format like this

rpc view will not decompile whether idl is an implicit handle or a display handle, you need to try it yourself 

### The third recurring vulnerability is CVE-2020-17012 

To start the driver, refer to http://revertservice.com/10/bindflt

From the perspective of the patch, Microsoft directly does not allow ordinary users to call the IOCTL dispatch function BfDrvDeviceControl

The cause of the vulnerability is that BfDrvDeviceControl did not verify the value in the input buffer, and then called directly
RtlInitUnicodeString refers to the value in the buffer caused 

nt!RtlInitUnicodeString+0x23:
fffff803`5843df53 66833c4200      cmp     word ptr [rdx+rax*2],0 ds:002b:41414141`41414141=????
Resetting default scope

PROCESS_NAME:  poc.exe

STACK_TEXT:  
ffffe888`ddfcd658 fffff803`606bbb70 : ffffd80d`8d339e38 ffff860d`d605e410 00000000`00000000 ffffd80d`91c4d580 : nt!RtlInitUnicodeString+0x23
ffffe888`ddfcd660 fffff803`606bbd30 : 41414141`41414141 00000000`00000000 00000000`00000000 00000000`00000000 : bindflt!BfpInternalAttachFilterAndGetRootId+0x60
ffffe888`ddfcd750 fffff803`606bac2a : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : bindflt!BfpConfigureMappingForIoctl+0x68
ffffe888`ddfcd7f0 fffff803`58431819 : ffffd80d`91799100 00000000`00000000 00000000`00000001 ffffd80d`91799218 : bindflt!BfDrvDeviceControl+0x3a
ffffe888`ddfcd820 fffff803`589e7215 : ffffe888`ddfcdb80 ffffd80d`91799100 00000000`00000001 ffffd80d`92266910 : nt!IofCallDriver+0x59
ffffe888`ddfcd860 fffff803`589e7020 : 00000000`00000000 ffffe888`ddfcdb80 ffffd80d`91799100 ffffe888`ddfcdb80 : nt!IopSynchronousServiceTail+0x1a5
ffffe888`ddfcd900 fffff803`589e63f6 : 00007ffd`654b6360 00000000`00000000 00000000`00000000 00000000`00000000 : nt!IopXxxControlFile+0xc10
ffffe888`ddfcda20 fffff803`585d1518 : 00000000`00000000 00000000`00000000 00000000`00000000 fffff803`58aace5d : nt!NtDeviceIoControlFile+0x56
ffffe888`ddfcda90 00007ffd`6603c144 : 00007ffd`63ca57b7 00000000`00000000 0000a31b`6c575171 00000000`00000000 : nt!KiSystemServiceCopyEnd+0x28
000000c4`0ecff918 00007ffd`63ca57b7 : 00000000`00000000 0000a31b`6c575171 00000000`00000000 00007ffd`65fc9bc7 : ntdll!NtDeviceIoControlFile+0x14

