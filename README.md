# Vulnerability recurrence 

### The first loophole to reproduce is  CVE-2020-1021 

The code is based on an excellent vulnerability report  https://github.com/guhe120/Windows-EoP/blob/master/CVE-2020-1021/writeup.docx 

This code is only capable of triggering vulnerabilities wersvc!CWerService::SvcCollectMemoryInfo

My experimental environment is 1903 x64

I want to record something：

If the MaxMessageLength field in the fourth parameter ALPC_PORT_ATTRIBUTES of NtAlpcConnectPort is not set, then the length of the message sent by NtAlpcSendWaitReceivePort cannot exceed 0x200, and a 0xC000002F will be returned

If the sending length exceeds the maximum length specified by the server (NtAlpcSendWaitReceivePort is the third parameter from the bottom), you will get a 0xC0000707 

CreateFile will not be affected by disk storage space. WriteFile will 

### The second recurring vulnerability is CVE-2020-1515 

My experimental environment is 1903 x64

This is an integer overflow vulnerability in tapisrv.dll. From the perspective of the patch, the functions that have been patched include PInitialize, LInitialize, GetUIDllName and other functions, and the causes of the vulnerability are all integers, overflow，This vulnerability is an out-of-bounds heap write caused by an integer overflow. 

One big limitation is that in order to trigger an overflow, the server needs to have enough memory, otherwise it will return rpc error 14 

To call these functions, you need to connect to the tapisrv.dll server as an rpc client, and then you need to call ClientAttach to get a context_handle, and then call ClientAttach. ClientAttach will choose which function to call according to the value of parameter three

This code calls PInitialize, bypasses IsBadStringParam, but is only close to overflow 

1: kd>   
tapisrv!PInitialize+0xa3:  
0033:00007ffe 39672a63 4503c7 add r8d,r15d  
1: kd>   
tapisrv!PInitialize+0xa6:   
0033:00007ffe 39672a66 ff15dc980100 call qword ptr [tapisrv!_imp_HeapAlloc (00007ffe 3968c348)]   
1: kd> r r8   
r8=00000000ffffff6c    

I want to record something： 

By default, the rpc server will have the parameter to check [in], but not [out], because the server will not accept the value with the [out] parameter, but only accepts a format like this

rpc view will not decompile whether idl is an implicit handle or a display handle, you need to try it yourself 

### The third recurring vulnerability is CVE-2020-17012 

To start the driver, refer to http://revertservice.com/10/bindflt

From the perspective of the patch, Microsoft directly does not allow ordinary users to call the IOCTL dispatch function BfDrvDeviceControl

The cause of the vulnerability is that BfDrvDeviceControl did not verify the value in the input buffer, and then called directly
RtlInitUnicodeString refers to the value in the buffer caused 

nt!RtlInitUnicodeString + 0x23:
fffff8035843df53 66833c4200      cmp     word ptr[rdx + rax * 2], 0 ds:002b : 4141414141414141= ? ? ? ?
Resetting default scope

PROCESS_NAME : poc.exe

STACK_TEXT :
ffffe888ddfcd658 fffff803606bbb70 : ffffd80d8d339e38 ffff860dd605e410 0000000000000000 ffffd80d91c4d580 : nt!RtlInitUnicodeString + 0x23
ffffe888ddfcd660 fffff803606bbd30 : 4141414141414141 0000000000000000 0000000000000000 0000000000000000 : bindflt!BfpInternalAttachFilterAndGetRootId + 0x60
ffffe888ddfcd750 fffff803606bac2a : 0000000000000000 0000000000000000 0000000000000000 0000000000000000 : bindflt!BfpConfigureMappingForIoctl + 0x68
ffffe888ddfcd7f0 fffff80358431819 : ffffd80d91799100 0000000000000000 0000000000000001 ffffd80d91799218 : bindflt!BfDrvDeviceControl + 0x3a
ffffe888ddfcd820 fffff803589e7215 : ffffe888ddfcdb80 ffffd80d91799100 0000000000000001 ffffd80d92266910 : nt!IofCallDriver + 0x59
ffffe888ddfcd860 fffff803589e7020 : 0000000000000000 ffffe888ddfcdb80 ffffd80d91799100 ffffe888ddfcdb80 : nt!IopSynchronousServiceTail + 0x1a5
ffffe888ddfcd900 fffff803589e63f6 : 00007ffd654b6360 0000000000000000 0000000000000000 0000000000000000 : nt!IopXxxControlFile + 0xc10
ffffe888ddfcda20 fffff803585d1518 : 0000000000000000 0000000000000000 0000000000000000 fffff80358aace5d : nt!NtDeviceIoControlFile + 0x56
ffffe888ddfcda90 00007ffd6603c144 : 00007ffd63ca57b7 0000000000000000 0000a31b6c575171 0000000000000000 : nt!KiSystemServiceCopyEnd + 0x28
000000c40ecff918 00007ffd63ca57b7 : 0000000000000000 0000a31b6c575171 0000000000000000 00007ffd65fc9bc7 : ntdll!NtDeviceIoControlFile + 0x14
